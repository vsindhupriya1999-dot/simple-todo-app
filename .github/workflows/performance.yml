name: Performance Tests (k6)

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'tests/performance/**'
      - 'package.json'
      - '.github/workflows/performance.yml'

  schedule:
    - cron: '0 2 * * *'

  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select performance test type'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - baseline
          - load
          - stress
          - soak
      duration:
        description: 'Override duration (e.g., 30m for soak)'
        required: false
        type: string

concurrency:
  group: performance-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # PROD GUARD
  # ============================================================================
  guard:
    name: ðŸ›¡ï¸ Prod Guard Check
    runs-on: ubuntu-latest
    steps:
      - name: Verify BASE_URL is not production
        env:
          STAGING_BASE_URL: ${{ secrets.STAGING_BASE_URL }}
        run: |
          BASE_URL="${STAGING_BASE_URL:-http://localhost:3013}"
          echo "Resolved BASE_URL: $BASE_URL"

          if [[ "$BASE_URL" =~ prod|production ]]; then
            echo "âŒ SECURITY: Production URL detected"
            exit 1
          fi

          echo "âœ… BASE_URL check passed"

  # ============================================================================
  # SMOKE TEST (PR + manual)
  # ============================================================================
  smoke-test:
    name: ðŸ”¥ Smoke Test
    needs: guard
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_type == 'smoke')
    steps:
      - uses: actions/checkout@v4
      - uses: grafana/setup-k6-action@v1
      - run: sudo apt-get update && sudo apt-get install -y jq

      - name: Start API Server
        run: |
          npm ci
          npm start &
          for i in {1..60}; do
            curl -fsS http://localhost:3013/api/about && break || sleep 1
          done

      - name: Run Smoke Test
        run: |
          mkdir -p test-results
          k6 run \
            --vus 5 \
            --duration 60s \
            --out json=test-results/smoke-results.json \
            tests/performance/perf-smoke.test.js \
            2>&1 | tee test-results/smoke.log

      - name: Parse and Print Results Summary
        if: always()
        run: |
          echo "## ðŸ”¥ Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          jq -r '
            "| P95 | \(.metrics.http_req_duration.values.p95)ms |\n" +
            "| P99 | \(.metrics.http_req_duration.values.p99)ms |\n" +
            "| Error Rate | \(.metrics.http_req_failed.values.rate)% |"
          ' test-results/smoke-results.json >> $GITHUB_STEP_SUMMARY || true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-results
          path: test-results/

  # ============================================================================
  # BASELINE TEST (Nightly)
  # ============================================================================
  baseline-test:
    name: ðŸ“Š Baseline Test
    needs: guard
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_type == 'baseline')
    steps:
      - uses: actions/checkout@v4
      - uses: grafana/setup-k6-action@v1
      - run: sudo apt-get update && sudo apt-get install -y jq

      - name: Start API Server
        run: |
          npm ci
          npm start &
          for i in {1..60}; do
            curl -fsS http://localhost:3013/api/about && break || sleep 1
          done

      - name: Run Baseline Test
        run: |
          mkdir -p test-results
          k6 run \
            --out json=test-results/baseline-results.json \
            tests/performance/baseline.test.js \
            2>&1 | tee test-results/baseline.log

      - name: Parse and Print Results Summary
        if: always()
        run: |
          echo "## ðŸ“Š Baseline Test Results" >> $GITHUB_STEP_SUMMARY
          jq -r '
            "| P95 | \(.metrics.http_req_duration.values.p95)ms |\n" +
            "| P99 | \(.metrics.http_req_duration.values.p99)ms |\n" +
            "| Throughput | \(.metrics.http_reqs.values.rate) req/s |"
          ' test-results/baseline-results.json >> $GITHUB_STEP_SUMMARY || true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: baseline-test-results
          path: test-results/

  # ============================================================================
  # LOAD TEST (Nightly)
  # ============================================================================
  load-test:
    name: ðŸ“ˆ Load Test
    needs: guard
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_type == 'load')
    steps:
      - uses: actions/checkout@v4
      - uses: grafana/setup-k6-action@v1
      - run: sudo apt-get update && sudo apt-get install -y jq

      - name: Start API Server
        run: |
          npm ci
          npm start &
          for i in {1..60}; do
            curl -fsS http://localhost:3013/api/about && break || sleep 1
          done

      - name: Run Load Test
        run: |
          mkdir -p test-results
          k6 run \
            --out json=test-results/load-results.json \
            tests/performance/load.test.js \
            2>&1 | tee test-results/load.log

      - name: Parse and Print Results Summary
        if: always()
        run: |
          echo "## ðŸ“ˆ Load Test Results" >> $GITHUB_STEP_SUMMARY
          jq -r '
            "| P95 | \(.metrics.http_req_duration.values.p95)ms |\n" +
            "| P99 | \(.metrics.http_req_duration.values.p99)ms |\n" +
            "| Throughput | \(.metrics.http_reqs.values.rate) req/s |\n" +
            "| Error Rate | \(.metrics.http_req_failed.values.rate)% |"
          ' test-results/load-results.json >> $GITHUB_STEP_SUMMARY || true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-results
          path: test-results/

  # ============================================================================
  # STRESS TEST (Manual)
  # ============================================================================
  stress-test:
    name: âš¡ Stress Test
    needs: guard
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_type == 'stress'
    steps:
      - uses: actions/checkout@v4
      - uses: grafana/setup-k6-action@v1

      - name: Run Stress Test
        run: |
          mkdir -p test-results
          k6 run \
            --out json=test-results/stress-results.json \
            tests/performance/stress.test.js \
            2>&1 | tee test-results/stress.log

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stress-test-results
          path: test-results/

  # ============================================================================
  # SOAK TEST (Manual)
  # ============================================================================
  soak-test:
    name: ðŸ§ª Soak Test
    needs: guard
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_type == 'soak'
    steps:
      - uses: actions/checkout@v4
      - uses: grafana/setup-k6-action@v1

      - name: Run Soak Test
        run: |
          mkdir -p test-results
          k6 run \
            --duration "${{ github.event.inputs.duration || '30m' }}" \
            --out json=test-results/soak-results.json \
            tests/performance/soak.test.js \
            2>&1 | tee test-results/soak.log

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: soak-test-results
          path: test-results/
